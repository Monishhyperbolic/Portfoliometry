<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trade Daddy - AI Portfolio Analysis</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background: linear-gradient(135deg, #1a1a2e, #16213e); min-height: 100vh; color: #fff; }
    .container { max-width: 1200px; margin: auto; padding: 2rem; }
    .section { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); }
    .section h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #00ff88; }
    .section p, pre { color: #ccc; font-size: 1rem; }
    .portfolio-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .portfolio-table th, .portfolio-table td { padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left; }
    .portfolio-table th { background: rgba(0,255,136,0.2); color: #00ff88; }
    .positive { color: #00ff88; }
    .negative { color: #ff4d4d; }
    .btn { padding: 0.75rem 1.5rem; background: #00ff88; border: none; border-radius: 8px; color: #1a1a2e; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 1rem; }
    .btn:hover { background: #00cc6f; transform: translateY(-2px); }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav style="background: rgba(255, 255, 255, 0.05); padding: 1rem; text-align: center;">
    <a href="/" style="color: #00ff88; text-decoration: none; margin: 0 1rem;">Home</a>
    <a href="/dashboard.html" style="color: #00ff88; text-decoration: none; margin: 0 1rem;">Dashboard</a>
    <a href="/trading.html" style="color: #00ff88; text-decoration: none; margin: 0 1rem;">Trading Terminal</a>
    <a href="/ai-portfolio.html" style="color: #00ff88; text-decoration: none; margin: 0 1rem;">AI Portfolio Analyser</a>
    <a href="/ai-news.html" style="color: #00ff88; text-decoration: none; margin: 0 1rem;">AI News Analyser</a>
    <button id="logoutBtn" style="background: none; border: none; color: #ff5555; cursor: pointer; font-size: 1rem;">Logout</button>
  </nav>

  <!-- Main Container -->
  <div class="container">
    <div class="section" id="login-prompt" style="display: none;">
      <h2>Login Required</h2>
      <p>Please log in to view your portfolio and analysis.</p>
      <a href="/login.html" class="btn">Log In</a>
    </div>

    <div class="section" id="summary-section" style="display: none;">
      <h2>Account Summary</h2>
      <p><strong>Balance:</strong> <span id="balance">$0.00</span></p>
      <p><strong>Holdings JSON:</strong></p>
      <pre id="holdings-json">{}</pre>
    </div>

    <div class="section" id="portfolio-section" style="display: none;">
      <h2>Portfolio Holdings</h2>
      <table class="portfolio-table" id="portfolio-table">
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Quantity</th>
            <th>Buy Price</th>
            <th>Current Price</th>
            <th>Value</th>
            <th>Gain/Loss</th>
            <th>Sector</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section" id="ai-analysis-section" style="display: none;">
      <h2>AI Portfolio Analysis</h2>
      <p>This section will contain AI-generated insights from your portfolio holdings.</p>
    </div>
  </div>

  <!-- Footer -->
  <footer style="background: rgba(255, 255, 255, 0.05); padding: 1rem; text-align: center; color: #ccc;">
    <p>Â© 2025 Trade Daddy. All rights reserved.</p>
  </footer>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;
    const SUPABASE_URL = "https://knzgscqehdmaoudbgdqy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuemdzY3FlaGRtYW91ZGJnZHF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNDM0MDQsImV4cCI6MjA2MTkxOTQwNH0.ca5ytJBtnNB8oVXqRvSqVXZqa_kBl35fbr9xhy59AYo";
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function initialize() {
      const { data: { session }, error } = await supabaseClient.auth.getSession();
      const loginPrompt = document.getElementById("login-prompt");

      if (!session || !session.user) {
        loginPrompt.style.display = "block";
        return;
      }

      loginPrompt.style.display = "none";

      const userEmail = session.user.email;
      await fetchHoldingsMeta(userEmail);
      await fetchPortfolio(userEmail);
    }

    async function fetchHoldingsMeta(email) {
      const { data, error } = await supabaseClient
        .from("portfolio")
        .select("balance, holdings")
        .eq("email", email)
        .single();

      if (error || !data) {
        console.error("Error fetching summary:", error?.message);
        return;
      }

      document.getElementById("summary-section").style.display = "block";
      document.getElementById("balance").textContent = `$${data.balance.toFixed(2)}`;
      document.getElementById("holdings-json").textContent = JSON.stringify(data.holdings, null, 2);
      analyzeWithAI(data.holdings);
    }

    async function fetchPortfolio(email) {
      const { data, error } = await supabaseClient
        .from("portfolio")
        .select("holdings")
        .eq("email", email)
        .single();

      if (error || !data) {
        console.error("Error fetching portfolio:", error?.message);
        return;
      }

      document.getElementById("portfolio-section").style.display = "block";
      const tbody = document.querySelector("#portfolio-table tbody");
      tbody.innerHTML = "";

      const holdings = data.holdings || {};
      const entries = Object.entries(holdings);

      if (entries.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7">No holdings found.</td></tr>`;
        return;
      }

      entries.forEach(([ticker, h]) => {
        const quantity = h.quantity || 0;
        const buyPrice = h.buy_price || 0;
        const currentPrice = h.current_price || buyPrice;
        const value = quantity * currentPrice;
        const gainLoss = (currentPrice - buyPrice) * quantity;
        const sector = h.sector || "N/A";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${ticker}</td>
          <td>${quantity}</td>
          <td>$${buyPrice.toFixed(2)}</td>
          <td>$${currentPrice.toFixed(2)}</td>
          <td>$${value.toFixed(2)}</td>
          <td class="${gainLoss >= 0 ? 'positive' : 'negative'}">$${gainLoss.toFixed(2)}</td>
          <td>${sector}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function analyzeWithAI(holdingsJson) {
      document.getElementById("ai-analysis-section").style.display = "block";
      // AI analysis placeholder - you can add more complex analysis here
      console.log("Sending holdings to AI (stub):", holdingsJson);
    }

    document.addEventListener("DOMContentLoaded", initialize);
  </script>
</body>
</html>
