<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Daddy - AI Portfolio Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #00ff88;
        }

        .section p {
            color: #ccc;
            font-size: 1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .card h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .card p {
            color: #ccc;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            background: #00ff88;
            color: #1a1a2e;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            background: #00cc6f;
            transform: translateY(-2px);
        }

        iframe {
            border: none;
            width: 100%;
        }

        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .portfolio-table th,
        .portfolio-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .portfolio-table th {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            font-weight: 600;
        }

        .portfolio-table td {
            color: #ccc;
        }

        .portfolio-table tr:last-child td {
            border-bottom: none;
        }

        .positive {
            color: #00ff88;
        }

        .negative {
            color: #ff4d4d;
        }

        .login-prompt {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .section h2 {
                font-size: 1.25rem;
            }

            .portfolio-table {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <iframe src="navbar.html" height="80px"></iframe>

    <div class="container">
        <div class="section">
            <h2>AI Portfolio Analysis</h2>
            <p>Optimize your portfolio with AI-driven recommendations. Our advanced models assess risk and forecast performance to help you make informed decisions.</p>
        </div>

        <div class="section" id="portfolio-section">
            <h2>Portfolio Holdings</h2>
            <div id="login-prompt" class="login-prompt" style="display: none;">
                <p>Please log in to view your portfolio.</p>
                <a href="/login.html" class="btn">Log In</a>
            </div>
            <table class="portfolio-table" id="portfolio-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>Quantity</th>
                        <th>Buy Price</th>
                        <th>Current Price</th>
                        <th>Value</th>
                        <th>Gain/Loss</th>
                        <th>Sector</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="section" id="risk-assessment-section" style="display: none;">
            <h2>Risk Assessment</h2>
            <div class="grid" id="risk-assessment">
                <div class="card">
                    <h3>Portfolio Risk</h3>
                    <p>Loading...</p>
                </div>
                <div class="card">
                    <h3>Diversification</h3>
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <div class="section" id="performance-forecast-section" style="display: none;">
            <h2>Performance Forecast</h2>
            <div class="grid" id="performance-forecast">
                <div class="card">
                    <h3>Expected Returns</h3>
                    <p>Loading...</p>
                </div>
                <div class="card">
                    <h3>Optimization</h3>
                    <p>Loading...</p>
                </div>
            </div>
            <a href="#optimize" class="btn">Optimize Portfolio</a>
        </div>
    </div>

    <!-- Footer -->
    <iframe src="footer.html" height="200px"></iframe>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "YOUR_SUPABASE_URL"; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY"; // Replace with your Supabase anon key
        const GROQ_API_KEY = "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";

        // Initialize Supabase client
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Check authentication and fetch portfolio
        async function initialize() {
            const { data: { session } } = await supabase.auth.getSession();
            const loginPrompt = document.getElementById("login-prompt");
            const portfolioSection = document.getElementById("portfolio-table");
            const riskSection = document.getElementById("risk-assessment-section");
            const forecastSection = document.getElementById("performance-forecast-section");

            if (!session) {
                loginPrompt.style.display = "block";
                portfolioSection.style.display = "none";
                riskSection.style.display = "none";
                forecastSection.style.display = "none";
                return;
            }

            loginPrompt.style.display = "none";
            portfolioSection.style.display = "table";
            riskSection.style.display = "block";
            forecastSection.style.display = "block";

            await fetchPortfolio(session.user.id);
        }

        // Fetch portfolio from Supabase
        async function fetchPortfolio(userId) {
            try {
                const { data, error } = await supabase
                    .from("portfolio")
                    .select("ticker, quantity, buy_price, current_price, sector")
                    .eq("user_id", userId);

                if (error) {
                    throw new Error(`Supabase error: ${error.message}`);
                }

                if (!data || data.length === 0) {
                    document.querySelector("#portfolio-table tbody").innerHTML = `
                        <tr><td colspan="7">No holdings found.</td></tr>
                    `;
                    document.getElementById("risk-assessment").innerHTML = `
                        <div class="card"><h3>Error</h3><p>No portfolio data available.</p></div>
                    `;
                    document.getElementById("performance-forecast").innerHTML = `
                        <div class="card"><h3>Error</h3><p>No portfolio data available.</p></div>
                    `;
                    return;
                }

                // Populate portfolio table
                populatePortfolioTable(data);

                // Analyze portfolio with Groq
                await analyzePortfolio(data);
            } catch (error) {
                console.error('Fetch portfolio error:', error);
                document.querySelector("#portfolio-table tbody").innerHTML = `
                    <tr><td colspan="7">Error fetching portfolio: ${error.message}</td></tr>
                `;
                document.getElementById("risk-assessment").innerHTML = `
                    <div class="card"><h3>Error</h3><p>${error.message}</p></div>
                `;
                document.getElementById("performance-forecast").innerHTML = `
                    <div class="card"><h3>Error</h3><p>${error.message}</p></div>
                `;
            }
        }

        // Populate portfolio table
        function populatePortfolioTable(holdings) {
            const tbody = document.querySelector("#portfolio-table tbody");
            tbody.innerHTML = "";
            holdings.forEach(holding => {
                const currentPrice = holding.current_price || holding.buy_price; // Fallback if no current_price
                const value = (holding.quantity * currentPrice).toFixed(2);
                const gainLoss = ((currentPrice - holding.buy_price) * holding.quantity).toFixed(2);
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${holding.ticker}</td>
                    <td>${holding.quantity}</td>
                    <td>$${holding.buy_price.toFixed(2)}</td>
                    <td>$${currentPrice.toFixed(2)}</td>
                    <td>$${value}</td>
                    <td class="${gainLoss >= 0 ? 'positive' : 'negative'}">$${gainLoss}</td>
                    <td>${holding.sector}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Analyze portfolio with Groq API
        async function analyzePortfolio(holdings) {
            const prompt = `
You are a financial AI analyst. Analyze the following portfolio:

\`\`\`json
${JSON.stringify(holdings, null, 2)}
\`\`\`

Provide a structured response with:
- **Portfolio Risk**: Assess risk level (low/moderate/high) and explain based on volatility, sector concentration, or other factors.
- **Diversification**: Evaluate if the portfolio is well-diversified. Suggest improvements (e.g., add sectors, reduce concentration).
- **Expected Returns**: Estimate annualized return (e.g., 5-10%) based on historical trends, market conditions, or asset performance. Justify.
- **Optimization Suggestions**: Recommend actions (e.g., buy/sell, rebalance, diversify) to improve risk-adjusted returns.

Return the response in JSON format:
\`\`\`json
{
  "portfolio_risk": {"level": "moderate", "explanation": "..."},
  "diversification": {"status": "moderately diversified", "suggestion": "..."},
  "expected_returns": {"estimate": "8%", "justification": "..."},
  "optimization": {"suggestions": "..."}
}
\`\`\`
`;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "llama3-70b-8192",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.5
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Groq API error:', {
                        status: response.status,
                        statusText: response.statusText,
                        body: errorText
                    });
                    throw new Error(`Groq API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const reply = result?.choices?.[0]?.message?.content || "{}";
                let analysis;
                try {
                    analysis = JSON.parse(reply);
                } catch (e) {
                    console.error('Failed to parse Groq response:', reply);
                    throw new Error("Invalid response format from Groq API");
                }

                // Update Risk Assessment
                document.getElementById("risk-assessment").innerHTML = `
                    <div class="card">
                        <h3>Portfolio Risk</h3>
                        <p>${analysis.portfolio_risk?.level || "Unknown"}: ${analysis.portfolio_risk?.explanation || "No data available."}</p>
                    </div>
                    <div class="card">
                        <h3>Diversification</h3>
                        <p>${analysis.diversification?.status || "Unknown"}: ${analysis.diversification?.suggestion || "No data available."}</p>
                    </div>
                `;

                // Update Performance Forecast
                document.getElementById("performance-forecast").innerHTML = `
                    <div class="card">
                        <h3>Expected Returns</h3>
                        <p>${analysis.expected_returns?.estimate || "Unknown"}: ${analysis.expected_returns?.justification || "No data available."}</p>
                    </div>
                    <div class="card">
                        <h3>Optimization</h3>
                        <p>${analysis.optimization?.suggestions || "No suggestions available."}</p>
                    </div>
                `;

            } catch (error) {
                console.error('Analyze portfolio error:', error);
                let errorMessage = "Failed to analyze portfolio: " + error.message;
                if (error.message.includes("404")) {
                    errorMessage += " - Verify the endpoint in Groq documentation (https://console.groq.com/docs) or contact Groq support.";
                } else if (error.message.includes("401")) {
                    errorMessage += " - Invalid or expired API key. Verify your GROQ_API_KEY at https://console.groq.com.";
                } else if (error.message.includes("429")) {
                    errorMessage += " - Rate limit exceeded. Try again later or check your Groq plan.";
                }
                document.getElementById("risk-assessment").innerHTML = `
                    <div class="card"><h3>Error</h3><p>${errorMessage}</p></div>
                `;
                document.getElementById("performance-forecast").innerHTML = `
                    <div class="card"><h3>Error</h3><p>${errorMessage}</p></div>
                `;
            }
        }

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", initialize);
    </script>
</body>
</html>